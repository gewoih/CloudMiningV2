@using Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Collections.Specialized
@model IEnumerable<CloudMining.Domain.Models.ShareablePayment>

@{
	ViewData["Title"] = "Платежи";
}

<div id="app" v-cloak>
	<div class="loading-container" v-if="isLoading">
		<div class="loading-spinner"></div>
		<p class="loading-message">Загрузка данных...</p>
	</div>

	<div v-else>
		<select class="form-select" v-model="selectedPaymentType">
			<option selected value="Electricity">Электричество</option>
			<option value="Purchase">Покупки</option>
		</select>

		<table class="table table-striped table-hover display">
			<thead>
				<tr>
					<th>Сумма</th>
					<th>Дата</th>
					<th>Комментарий</th>
				</tr>
			</thead>
			<tbody>
				<tr v-for="payment in payments" :style="{ backgroundColor: payment.isCompleted ? '#A0FFAA' : '#FFB7A0' }">
					<td>{{ payment.amount }}</td>
					<td>{{ payment.date }}</td>
					<td>{{ payment.caption }}</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Добавить платеж</button>


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addPaymentModalLabel">Добавление нового платежа</h5>
			</div>
			<div class="modal-body">
				<form id="addPaymentForm">
					<div class="form-group">
						<label for="paymentCaption">Комментарий</label>
						<input type="text" class="form-control" id="paymentCaption" required>
					</div>
					<div class="form-group">
						<label for="paymentDate">Дата</label>
						<input type="date" class="form-control" id="paymentDate" required>
					</div>
					<div class="form-group">
						<label for="paymentAmount">Сумма</label>
						<input type="number" class="form-control" id="paymentAmount" required>
					</div>
					<div class="modal-footer border-top-0">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
						<button type="submit" class="btn btn-primary">Сохранить</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

@section Scripts
{
	<script>
		const app = Vue.createApp({
			data() {
				return {
					payments: [],
					selectedPaymentType: 'Electricity',
					isLoading: true,
				};
			},

			async mounted() {
				await this.fetchPayments();
			},

			methods: {
				async fetchPayments() {
					this.isLoading = true;

					try {
						const response = await axios.get('/api/payments');
						this.payments = response.data;
					} catch (error) {
						console.error('Error fetching data:', error);
					} finally {
						this.isLoading = false;
					}
				}
			}
		});

		app.mount('#app');

		$(document).ready(function () {
			$('#addPaymentForm').on('submit', function (e) {
				e.preventDefault();
				var data = {
					caption: $('#paymentCaption').val(),
					amount: $('#paymentAmount').val(),
					date: $('#paymentDate').val()
				};
				$.ajax({
					url: '/api/payments',
					type: 'POST',
					data: data,
					success: function (response) {
						$('#addPayment').modal('hide');
					}
				});
			});
		});
	</script>
}